# Tests for ../src/icmp.jl

@testset "icmp" begin
    bytes_headers = (
        (0x08, 0x00, 0x8f, 0x53, 0x12, 0x34, 0x56, 0x78) => ICMPHeader(ICMP_ECHO; id=0x1234, sequence=0x5678),
        (0x00, 0x00, 0x97, 0x53, 0x12, 0x34, 0x56, 0x78) => ICMPHeader(ICMP_ECHOREPLY; id=0x1234, sequence=0x5678),
        (0x0d, 0x00, 0x8a, 0x53, 0x12, 0x34, 0x56, 0x78) => ICMPHeader(ICMP_TIMESTAMP; id=0x1234, sequence=0x5678),
        (0x0e, 0x00, 0x89, 0x53, 0x12, 0x34, 0x56, 0x78) => ICMPHeader(ICMP_TIMESTAMPREPLY; id=0x1234, sequence=0x5678),
        (0x0f, 0x00, 0x88, 0x53, 0x12, 0x34, 0x56, 0x78) => ICMPHeader(ICMP_INFO_REQUEST; id=0x1234, sequence=0x5678),
        (0x10, 0x00, 0x87, 0x53, 0x12, 0x34, 0x56, 0x78) => ICMPHeader(ICMP_INFO_REPLY; id=0x1234, sequence=0x5678),
        (0x11, 0x00, 0x86, 0x53, 0x12, 0x34, 0x56, 0x78) => ICMPHeader(ICMP_ADDRESS; id=0x1234, sequence=0x5678),
        (0x12, 0x00, 0x85, 0x53, 0x12, 0x34, 0x56, 0x78) => ICMPHeader(ICMP_ADDRESSREPLY; id=0x1234, sequence=0x5678),
        (0x03, 0x01, 0xa6, 0x52, 0x00, 0x34, 0x56, 0x78) => ICMPHeader(ICMP_DEST_UNREACH; code=ICMP_HOST_UNREACH, length=0x34, mtu=0x5678),
        (0x05, 0x01, 0xe4, 0xe6, 0x0a, 0x0b, 0x0c, 0x0d) => ICMPHeader(ICMP_REDIRECT; code=ICMP_REDIR_HOST, gateway=ip"10.11.12.13"),
        (0x0c, 0x01, 0xe1, 0xfe, 0x12, 0x00, 0x00, 0x00) => ICMPHeader(ICMP_PARAMETERPROB, code=ICMP_MISSING_OPTION, pointer=0x12),
        (0x0b, 0x01, 0xf4, 0xfe, 0x00, 0x00, 0x00, 0x00) => ICMPHeader(ICMP_TIME_EXCEEDED; code=ICMP_EXC_FRAGTIME),
        (0x04, 0x00, 0xfb, 0xff, 0x00, 0x00, 0x00, 0x00) => ICMPHeader(ICMP_SOURCE_QUENCH),
        (0xab, 0xcd, 0xeb, 0x85, 0x12, 0x34, 0x56, 0x78) => ICMPHeader(0xab; code=0xcd, data=0x12345678)
    )

    @testset "icmp bytes" begin
        for (bytes, hdr) in bytes_headers
            @test bytes == hdr.bytes
            @test internet_checksum(hdr) === 0x000
        end
    end

    hdrs = last.(bytes_headers)
    repr_expected = (
        "ICMPHeader(ICMP_ECHO, 0x8f53, id=0x1234, sequence=0x5678)",
        "ICMPHeader(ICMP_ECHOREPLY, 0x9753, id=0x1234, sequence=0x5678)",
        "ICMPHeader(ICMP_TIMESTAMP, 0x8a53, id=0x1234, sequence=0x5678)",
        "ICMPHeader(ICMP_TIMESTAMPREPLY, 0x8953, id=0x1234, sequence=0x5678)",
        "ICMPHeader(ICMP_INFO_REQUEST, 0x8853, id=0x1234, sequence=0x5678)",
        "ICMPHeader(ICMP_INFO_REPLY, 0x8753, id=0x1234, sequence=0x5678)",
        "ICMPHeader(ICMP_ADDRESS, 0x8653, id=0x1234, sequence=0x5678)",
        "ICMPHeader(ICMP_ADDRESSREPLY, 0x8553, id=0x1234, sequence=0x5678)",
        "ICMPHeader(ICMP_DEST_UNREACH, 0xa652, code=ICMP_HOST_UNREACH, length=0x56, mtu=0x5678)",
        "ICMPHeader(ICMP_REDIRECT, 0xe4e6, code=ICMP_REDIR_HOST, gateway=ip\"10.11.12.13\")",
        "ICMPHeader(ICMP_PARAMETERPROB, 0xe1fe, code=ICMP_MISSING_OPTION, pointer=0x12)",
        "ICMPHeader(ICMP_TIME_EXCEEDED, 0xf4fe, code=ICMP_EXC_FRAGTIME)",
        "ICMPHeader(ICMP_SOURCE_QUENCH, 0xfbff)",
        "ICMPHeader(0xab, 0xcd, 0xeb85, 0x12345678)"
    )

    @testset "icmp show" begin
        for (hdr, exp) in zip(hdrs, repr_expected)
            @test repr(hdr) == exp
        end
    end
end # testset "ICMP"
